<script>

    const messageList = document.getElementById('Messages-Wrapper');
    messageList.scrollTop = messageList.scrollHeight;
    const newMessageWrap = document.getElementById('New-Message-Wrapper');
    let userName = document.getElementById('Username-Hidden').innerText;
    let lastMessageID = '';

    if(messageList.children.length > 0){
        lastMessageID = $("#Messages-Wrapper div").last()[0].id;
    }else{
        console.log('no messages');
    }

    const loadMessageLoop = () => {
        setInterval(() => {
            loadMessages();
        }, 500);
    };

    loadMessageLoop();

    const loadMessages = () => {
        let tempURL = '/chat?uName=' + userName;
        $.ajax({url: tempURL ,method:'GET'});
        $.ajax({url: tempURL ,method:'GET'})
            .then((data) => {
                
                let node = new DOMParser().parseFromString(data,'text/html').body;
                let wrapchildren = node.querySelector('#Messages-Wrapper').children;
                let cycledOldMessages = false;
                for(let i = 0; i < wrapchildren.length; i++){
                    let tempID = wrapchildren[i].id;
                    if(cycledOldMessages){
                        
                        if(i+1 == wrapchildren.length){
                            lastMessageID = tempID;
                            messageList.appendChild(wrapchildren[i]);
                        }else{
                            messageList.appendChild(wrapchildren[i]);
                        }

                        messageList.scrollTop = messageList.scrollHeight;

                    }else{
                        if(lastMessageID == tempID){
                            cycledOldMessages = true;
                        }
                    }
                }
            });
    };

    newMessageWrap.addEventListener("keydown", (e) => {
        if(e.keyCode == 8 || e.keyCode == 46){
            if(newMessageWrap.children.length === 1){
                if(newMessageWrap.children[0].innerText < 1){
                    e.preventDefault();
                }
            }
        }else if(e.keyCode == 13){
            e.preventDefault();
            sendMessage();
        }
    });

    const sendMessage = (un) => {
        let messageObj = document.getElementById('New-Message');
        if(messageObj.innerText.length > 0){
            let data = {
            'sender': userName,
            'content': messageObj.innerText
            }
            $.ajax({
                method: 'POST',
                url: '/chat',
                dataType: 'application/json; charset=utf-8',
                data: data
            }).then((data) => {
                console.log(data);
            });
            messageObj.innerText = '';
            loadMessages();
        }
    };
</script>